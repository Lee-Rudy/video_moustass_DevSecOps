name: SonarCloud

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  sonar:
    name: SonarCloud scan (never fail CI)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: maven

      - name: Cache SonarCloud
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # 1) Build + tests + JaCoCo report
      # -maven.test.failure.ignore=true => tests peuvent échouer sans casser l'étape
      - name: Build + Tests + JaCoCo (ignore test failures)
        run: |
          mvn -B clean verify -Dmaven.test.failure.ignore=true

      # (Optionnel) Debug si tu veux confirmer que jacoco.xml existe
      - name: Debug JaCoCo report
        run: |
          ls -la target/site/jacoco || true
          test -f target/site/jacoco/jacoco.xml && echo "jacoco.xml OK" || echo "jacoco.xml NOT FOUND"

      # 2) SonarCloud analysis (ne pas échouer le workflow si Sonar échoue)
      - name: SonarCloud analyze
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B sonar:sonar \
            -Dsonar.projectKey=Lee-Rudy_video_moustass_DevSecOps \
            -Dsonar.organization=lee-rudy \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
